OpenDroidPDF – Class/Package Structure (Updated 2025-12-25)
===========================================================

Purpose
-------
This file is a quick map of the major classes and packages under `platform/android/`
so that “who owns what” is obvious without spelunking.

Canonical ownership rules and the living ownership map are in:
- `docs/architecture.md`
- `plan.md` (progress tracking + phase checklists)

OpenDroidPDFActivity
~~~~~~~~~~~~~

OpenDroidPDFActivity (formerly PenAndPDFActivity) is the main activity used when
displaying and interacting with a document.

Current responsibility (by design): **thin host** (lifecycle + wiring + top-level routing).
Most flow logic should live in controllers/services that are wired from:
- `org.opendroidpdf.app.lifecycle.ActivityComposition`

The app also has an app-scope service locator:
- `org.opendroidpdf.app.AppServices`
which owns long-lived app-scoped services/stores (preferences + recents store).


Main view classes
~~~~~~~~~~~~~~~~~

ReaderView / MuPDFReaderView
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
MuPDF uses an Adapter/AdapterView-style stack:
- `org.opendroidpdf.ReaderView` is the AdapterView-style container.
- `org.opendroidpdf.MuPDFReaderView` is the MuPDF-specific subclass.

Intentional responsibility split:
- Views own **layout + hosting** (child management, invalidate/measure/layout).
- Gesture/selection/drawing logic is owned by controllers/routers (see below),
  not by the view itself.

MuPDFReaderView
~~~~~~~~~~~~~~~
MuPDFReaderView hosts page views via adapters:
- `org.opendroidpdf.MuPDFPageAdapter` (fixed-layout docs, e.g., PDFs)
- `org.opendroidpdf.MuPDFReflowAdapter` (reflow docs, e.g., EPUB via MuPDF reflow)

MuPDFView
~~~~~~~~~
`org.opendroidpdf.MuPDFView` is the common interface implemented by:
- `org.opendroidpdf.MuPDFPageView`
- `org.opendroidpdf.MuPDFReflowView`

PageView
~~~~~~~~
`org.opendroidpdf.PageView` is the main ViewGroup used for fixed-layout page display.
It owns the multi-layer rendering surface (base tile + high-res tile + overlay).

MuPDFPageView
~~~~~~~~~~~~~
`org.opendroidpdf.MuPDFPageView` is the fixed-layout page view (PDF, etc).
It implements `MuPDFView` and delegates “real work” to document-scoped controllers
created by `org.opendroidpdf.app.reader.ReaderComposition` (see below).

MuPDFReflowView
~~~~~~~~~~~~~~~
`org.opendroidpdf.MuPDFReflowView` is used for reflow docs (EPUB via MuPDF reflow).
It implements `MuPDFView` and is backed by MuPDF’s reflow layout/rendering.

MuPDFPageAdapter and MuPDFReflowAdapter
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Adapters are responsible for supplying page subviews on demand and caching page size
metadata where needed. Most per-document coordination is done outside the adapters.


C library wrapper
~~~~~~~~~~~~~~~~~

MuPDFCore / OpenDroidPDFCore
~~~~~~~~~~~~~~~~~~~~~~~~~~~
MuPDF's legacy JNI wrapper classes currently live in the app module (`platform/android/src/`):
- `org.opendroidpdf.MuPDFCore` (JNI bridge base)
- `org.opendroidpdf.OpenDroidPDFCore` (app-facing wrapper around `MuPDFCore`)

Android-light “core model” types live in the `:core` module (`platform/android/core/src/main/java/`), still under
the `org.opendroidpdf.*` package. The high-level repository/controller wrapper currently lives in the app module:
- `org.opendroidpdf.core.MuPdfController` / `org.opendroidpdf.core.MuPdfRepository`

Native/JNI implementation lives under:
- `platform/android/jni/`

Rule (target state): core/native work lives in `:core`; UI flows stay in the app module.


Composition roots (ownership by scope)
-------------------------------------

App-scope (lifetime: application/activity)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
- `org.opendroidpdf.app.lifecycle.ActivityComposition` wires controllers/adapters for the activity.
- `org.opendroidpdf.app.AppServices` provides app-scoped services/stores (preferences, recents store).

Document-scope (lifetime: an open document)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
- `org.opendroidpdf.app.reader.ReaderComposition` builds per-document controllers and optionally a
  `org.opendroidpdf.app.sidecar.SidecarAnnotationSession` for EPUB/read-only PDFs.

Core capability owners (selected)
---------------------------------
Navigation / open / save / export
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
- `org.opendroidpdf.app.document.DocumentNavigationController` (pick/open/save-as entry points).
- `org.opendroidpdf.app.document.DocumentSetupController` (open pipeline: identity + controller creation).
- `org.opendroidpdf.app.helpers.IntentRouter` (intent routing / resume behavior).
- `org.opendroidpdf.app.document.ExportController` (share/print/export prompts + routing).
- `org.opendroidpdf.app.document.FlattenedPdfExporter` (sidecar export: render + overlay composite → new PDF).

Document identity (canonical `docId`)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
- `org.opendroidpdf.app.document.DocumentIdentityResolver` resolves a stable `docId` once per open.
- `docId` is the canonical key for recents, viewport, and sidecar.

Gestures / selection (keep view responsibilities small)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
- `org.opendroidpdf.app.reader.gesture.ReaderGestureController` (top-level gesture coordinator).
- `org.opendroidpdf.app.selection.*` (selection router/handlers)
- `org.opendroidpdf.app.reader.ReaderGeometry` / `org.opendroidpdf.app.reader.NormalizedScroll` (geometry helpers)

Search
~~~~~~
- `org.opendroidpdf.app.services.SearchService` and `SearchServiceImpl` own search state and execution.
- UI binds through `org.opendroidpdf.app.search.SearchToolbarController`.

Ink / drawing / annotation mode
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
- `org.opendroidpdf.app.services.DrawingService` is the single owner for annotation mode state and
  “finalize pending ink” semantics.
- `org.opendroidpdf.app.annotation.PenSettingsController` updates pen settings via `PenPreferencesService`
  and coordinates ink finalization where required.
- Toolbar binding is owned by `org.opendroidpdf.app.annotation.AnnotationToolbarController`.

Sidecar annotations (EPUB + read-only PDFs)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
- `org.opendroidpdf.app.sidecar.SidecarAnnotationSession` is the in-memory session + undo/redo surface.
- `org.opendroidpdf.app.sidecar.SQLiteSidecarAnnotationStore` persists sidecar annotations (SQLite, WAL).
- `org.opendroidpdf.app.overlay.SidecarAnnotationRenderer` renders persisted sidecar annotations as an overlay
  on top of base page rendering (shared by viewer and export).

Reflow (EPUB)
~~~~~~~~~~~~~
- `org.opendroidpdf.app.reflow.ReflowSettingsController` owns reflow layout application and mismatch UI.
- `org.opendroidpdf.app.reflow.ReflowLayoutProfileId` computes a stable `layoutProfileId` from layout-affecting
  fields only (theme is paint-only and does not change the layoutProfileId).

Recents + viewport
~~~~~~~~~~~~~~~~~~
- `org.opendroidpdf.app.services.recent.RecentFilesStore` persists recents entries (current implementation uses
  SharedPreferences store).
- `org.opendroidpdf.app.document.DocumentViewportController` saves/restores viewport snapshots per `docId`.

Where to look next
------------------
- Ownership rules + hotspots: `docs/architecture.md`
- Refactor phases + progress entries: `plan.md`
- Smoke log and scripts: `docs/housekeeping/baseline_smoke.md` and `scripts/`
  (e.g., `scripts/geny_smoke.sh`, `scripts/geny_epub_smoke.sh`)
